<!DOCTYPE html>
<html>
<head>
    <title>Test Sauvegarde Images</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 5px; }
        .step h3 { margin-top: 0; color: #333; }
        .pass { border-color: #10b981; background: #d1fae5; }
        .fail { border-color: #ef4444; background: #fee2e2; }
        code { background: #f3f4f6; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üß™ Test de Sauvegarde des Images - Fiche Produit</h1>
    
    <div class="step">
        <h3>üìù Instructions :</h3>
        <ol>
            <li>Va sur <a href="http://stock-r4e.test/admin/product-sheets/create?article_type_id=880&console_id=19" target="_blank">Page de cr√©ation de fiche</a></li>
            <li>Clique sur "üì∏ G√©rer les photos de l'article"</li>
            <li>Dans la section "üñºÔ∏è Photos d'autres articles du m√™me type", clique sur "‚ûï Ajouter" sur une ou plusieurs images</li>
            <li>Ferme le modal</li>
            <li>V√©rifie que les images ajout√©es apparaissent dans la section "üì∑ Images de l'article"</li>
            <li>Ouvre la console du navigateur (F12) et tape : <code>console.log(window.uploadedGameImages)</code></li>
            <li>V√©rifie que tu vois un tableau avec les URLs des images</li>
            <li><strong>IMPORTANT</strong> : Remplis le formulaire et clique sur "üíæ Enregistrer"</li>
            <li>Note l'ID de la fiche cr√©√©e (dans l'URL apr√®s redirection)</li>
        </ol>
    </div>
    
    <div class="step">
        <h3>üîç V√©rification :</h3>
        <p>Apr√®s avoir cr√©√© la fiche, ouvre cette page de v√©rification :</p>
        <form id="checkForm" onsubmit="return checkSheet(event)">
            <label>ID de la fiche cr√©√©e : <input type="number" id="sheetId" required placeholder="Ex: 4"></label>
            <button type="submit">V√©rifier</button>
        </form>
        <div id="result" style="margin-top: 20px;"></div>
    </div>
    
    <script>
        async function checkSheet(event) {
            event.preventDefault();
            const sheetId = document.getElementById('sheetId').value;
            const resultDiv = document.getElementById('result');
            
            resultDiv.innerHTML = '<p>‚è≥ V√©rification en cours...</p>';
            
            try {
                const response = await fetch(`http://stock-r4e.test/admin/product-sheets/${sheetId}/edit`);
                const html = await response.text();
                
                // Parser la page pour extraire les donn√©es
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Chercher le champ hidden avec les images
                const imagesInput = doc.querySelector('input[name="images"]');
                const images = imagesInput ? JSON.parse(imagesInput.value || '[]') : [];
                
                if (images.length > 0) {
                    resultDiv.innerHTML = `
                        <div class="step pass">
                            <h3>‚úÖ SUCC√àS - ${images.length} image(s) sauvegard√©e(s)</h3>
                            <p><strong>Images trouv√©es :</strong></p>
                            <ul>
                                ${images.map((img, i) => `<li>${i + 1}. <code>${img.substring(img.length - 60)}</code></li>`).join('')}
                            </ul>
                            <p>Les images sont correctement sauvegard√©es en base de donn√©es ‚úì</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="step fail">
                            <h3>‚ùå √âCHEC - Aucune image sauvegard√©e</h3>
                            <p>Les images ajout√©es dans le modal n'ont pas √©t√© enregistr√©es.</p>
                            <p><strong>Causes possibles :</strong></p>
                            <ul>
                                <li>Le champ hidden <code>article_images_input</code> n'a pas √©t√© rempli</li>
                                <li>Le JavaScript n'a pas synchronis√© window.uploadedGameImages</li>
                                <li>Le formulaire a √©t√© soumis avant que les images soient ajout√©es</li>
                            </ul>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="step fail">
                        <h3>‚ùå ERREUR</h3>
                        <p>Impossible de v√©rifier la fiche : ${error.message}</p>
                        <p>Assure-toi que l'ID est correct et que tu es connect√©.</p>
                    </div>
                `;
            }
            
            return false;
        }
    </script>
</body>
</html>
